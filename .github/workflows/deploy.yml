name: DevSecOps Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

env:
  REGISTRY_NAME: ${{ secrets.ACR_NAME }}
  IMAGE_NAME: azure-ai-saas
  AKS_CLUSTER_NAME: axdev-cluster-02
  AKS_RESOURCE_GROUP: skax-axdev-gp3
  NAMESPACE_DEV: azure-ai-saas-dev
  NAMESPACE_PROD: azure-ai-saas

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: npm run lint
      continue-on-error: false

    - name: Run npm audit
      run: npm audit --audit-level=moderate
      continue-on-error: true

    - name: Build application
      run: npm run build

    - name: Run Trivy filesystem scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-fs-results.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy fs results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-fs-results.sarif'
        # Category 구분 (filesystem, image)
        category: 'trivy-fs'

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Log in to Azure Container Registry
      run: |
        az acr login --name ${{ env.REGISTRY_NAME }}

    # Buildx를 docker-container 드라이버로 생성
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
        cache-from: type=registry,ref=${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache
        cache-to: type=registry,ref=${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache,mode=max

    - name: Scan container image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-image-results.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy image scan results
    # Image SARIF는 있을 때만 업로드
      if: ${{ hashFiles('trivy-image-results.sarif') != '' }}
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-image-results.sarif'
        category: 'trivy-image'

  deploy-dev:
    needs: build-and-scan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: development
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: 'latest'

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set AKS context
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ env.AKS_RESOURCE_GROUP }}
        cluster-name: ${{ env.AKS_CLUSTER_NAME }}

    - name: Deploy to AKS using Helm (Development)
      run: |
        helm upgrade --install azure-ai-saas ./helm/azure-ai-saas \
          --namespace ${{ env.NAMESPACE_DEV }} \
          --create-namespace \
          --values ./helm/azure-ai-saas/values.yaml \
          --values ./helm/azure-ai-saas/values.dev.yaml \
          --set image.repository=${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }} \
          --set image.tag=${{ github.sha }} \
          --wait \
          --timeout 5m

    - name: Verify deployment
      run: |
        kubectl rollout status deployment/azure-ai-saas -n ${{ env.NAMESPACE_DEV }} --timeout=5m
        kubectl get pods -n ${{ env.NAMESPACE_DEV }}
        kubectl get svc -n ${{ env.NAMESPACE_DEV }}
        kubectl get httproute -n ${{ env.NAMESPACE_DEV }}

    - name: Rollback on failure
      if: failure()
      run: |
        helm rollback azure-ai-saas -n ${{ env.NAMESPACE_DEV }} || true

  deploy:
    needs: build-and-scan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: 'latest'

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set AKS context
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ env.AKS_RESOURCE_GROUP }}
        cluster-name: ${{ env.AKS_CLUSTER_NAME }}

    - name: Deploy to AKS using Helm (Production)
      run: |
        helm upgrade --install azure-ai-saas ./helm/azure-ai-saas \
          --namespace ${{ env.NAMESPACE_PROD }} \
          --create-namespace \
          --values ./helm/azure-ai-saas/values.yaml \
          --values ./helm/azure-ai-saas/values.prod.yaml \
          --set image.repository=${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }} \
          --set image.tag=${{ github.sha }} \
          --wait \
          --timeout 5m

    - name: Verify deployment
      run: |
        kubectl rollout status deployment/azure-ai-saas -n ${{ env.NAMESPACE_PROD }} --timeout=5m
        kubectl get pods -n ${{ env.NAMESPACE_PROD }}
        kubectl get svc -n ${{ env.NAMESPACE_PROD }}
        kubectl get httproute -n ${{ env.NAMESPACE_PROD }}

    - name: Rollback on failure
      if: failure()
      run: |
        helm rollback azure-ai-saas -n ${{ env.NAMESPACE_PROD }} || true